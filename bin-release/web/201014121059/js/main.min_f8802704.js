function newInstance(e,t){return new e(t)}function getConfigurableByType(e){var t=type2nameMap[e];return t?configuableMap[t]:(console.log("no cofiguarable found.type:"+e),null)}var __reflect=this&&this.__reflect||function(e,t,n){e.__class__=t,n?n.push(t):n=[t],e.__types__=e.__types__?n.concat(e.__types__):n},__extends=this&&this.__extends||function(e,t){function n(){this.constructor=e}for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i]);n.prototype=t.prototype,e.prototype=new n},__awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))(function(r,a){function s(e){try{h(i.next(e))}catch(t){a(t)}}function o(e){try{h(i["throw"](e))}catch(t){a(t)}}function h(e){e.done?r(e.value):new n(function(t){t(e.value)}).then(s,o)}h((i=i.apply(e,t||[])).next())})},__generator=this&&this.__generator||function(e,t){function n(e){return function(t){return i([e,t])}}function i(n){if(r)throw new TypeError("Generator is already executing.");for(;h;)try{if(r=1,a&&(s=a[2&n[0]?"return":n[0]?"throw":"next"])&&!(s=s.call(a,n[1])).done)return s;switch(a=0,s&&(n=[0,s.value]),n[0]){case 0:case 1:s=n;break;case 4:return h.label++,{value:n[1],done:!1};case 5:h.label++,a=n[1],n=[0];continue;case 7:n=h.ops.pop(),h.trys.pop();continue;default:if(s=h.trys,!(s=s.length>0&&s[s.length-1])&&(6===n[0]||2===n[0])){h=0;continue}if(3===n[0]&&(!s||n[1]>s[0]&&n[1]<s[3])){h.label=n[1];break}if(6===n[0]&&h.label<s[1]){h.label=s[1],s=n;break}if(s&&h.label<s[2]){h.label=s[2],h.ops.push(n);break}s[2]&&h.ops.pop(),h.trys.pop();continue}n=t.call(e,h)}catch(i){n=[6,i],a=0}finally{r=s=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}var r,a,s,o,h={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:n(0),"throw":n(1),"return":n(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o},RebounceObj=function(e){function t(){var t=e.call(this)||this;return t.deleteOnHit=!1,t}return __extends(t,e),t.prototype.onHit=function(e){var t=this.getTransformedBounds(GameManager.getInstance().stage).clone();t.inflate(e.width/2,e.height/2);var n=this.calcPoints(t,e);if(n.length>0){var i=this.calcFirstIntersecPoint(n,e);if(null!=i&&(i.x==t.left||i.x==t.right?e.revertXSpeed():(i.y==t.top||i.y==t.bottom)&&e.revertYSpeed(),this.deleteOnHit)){var r=GameManager.getInstance().entityMap[this.getName()].indexOf(this);r>=0&&GameManager.getInstance().entityMap[this.getName()].splice(r,1),GameManager.getInstance().stage.removeChild(this)}}},t.prototype.calcPoints=function(e,t){var n=[],i=[],r=e.left,a=e.bottom,s=e.right,o=e.top;if(0!=t.speedX){var h=t.speedY/t.speedX,c=t.y-t.x*h;if(h!=Number.POSITIVE_INFINITY&&h!=Number.NEGATIVE_INFINITY){var u=new egret.Point(r,h*r+c),l=new egret.Point(s,h*s+c);u.equals(l)?n.push(u):(n.push(u),n.push(l))}if(0!=h){var g=new egret.Point((o-c)/h,o),p=new egret.Point((a-c)/h,a);g.equals(p)?n.push(g):(n.push(g),n.push(p))}}else{var g=new egret.Point(t.x,o),p=new egret.Point(t.x,a);n.push(g),n.push(p)}for(var d=0,f=n;d<f.length;d++){var y=f[d];y.x<r||y.x>s||y.y<o||y.y>a||i.push(y)}return i},t.prototype.calcFirstIntersecPoint=function(e,t){if(e.length<2)return null;var n=e[0],i=e[1],r=Number.POSITIVE_INFINITY;0!=t.speedX&&(r=t.speedY/t.speedX);var a=Number.POSITIVE_INFINITY;return i.x!=n.x&&(a=(i.y-n.y)/(i.x-n.x)),r==Number.POSITIVE_INFINITY&&a==Number.POSITIVE_INFINITY?i.y>n.y?i:n:r==Number.POSITIVE_INFINITY||a==Number.POSITIVE_INFINITY?null:r*a>0?t.x>n.x?i:n:0>r*a?t.x<i.x?n:i:null},t}(egret.Sprite);__reflect(RebounceObj.prototype,"RebounceObj",["IFlexible","IConfigurable"]);var Brick=function(e){function t(t){var n=e.call(this)||this;return n.x=t.x,n.y=t.y,n.name=n.getName(),n.graphics.beginFill(t.color,1),n.graphics.drawRect(0,0,t.width,t.height),n.graphics.endFill(),n.deleteOnHit=!0,n}return __extends(t,e),t.prototype.getName=function(){return BRICK},t}(RebounceObj);__reflect(Brick.prototype,"Brick");var Wall=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return __extends(t,e),t.prototype.getName=function(){return WALL},t}(RebounceObj);__reflect(Wall.prototype,"Wall");var GameManager=function(){function e(){this.balls=[],this.entityMap={}}return e.getInstance=function(){return e.gm},e.prototype.addToEntityMap=function(e){if(null!=this.entityMap[e.getName()])this.entityMap[e.getName()].push(e);else{var t=new Array;t.push(e),this.entityMap[e.getName()]=t}},e.prototype.init=function(e){this.stage=e},e.prototype.stageSuccess=function(){console.log("stage success"),this.stage.dispatchEvent(new GameProcessEvent("STAGE_END")),StageMng.getInstance().isLastStage()?this.stage.dispatchEvent(new GameProcessEvent("GAME_END")):this.initStage(StageMng.getInstance().getNextStage())},e.prototype.isStageSuccess=function(){return null!=this.entityMap[BRICK]?this.entityMap[BRICK].length<=0:!0},e.prototype.isStageFail=function(){return this.balls.length<=0},e.prototype.stageFail=function(){this.stage.dispatchEvent(new GameProcessEvent("STAGE_END"));var e=new GameProcessEvent("GAME_END");this.stage.dispatchEvent(e)},e.prototype._resetFields=function(){this.balls=[],this.entityMap={},this.trigger=null,this.bat=null,null!=this.stage&&this.stage.removeChildren()},e.prototype.initStage=function(e){this._resetFields(),this.bat=new Bat(this.stage),this.stage.addChild(this.bat);var t=new Ball(this.bat.x+50,this.bat.y-20);this.balls.push(t),this.stage.addChild(t),(null==e||void 0==e)&&(console.log("[error] stageConfig not exist!"),e=RES.getRes("demo_json"));for(var n=0,i=e.configurables;n<i.length;n++){var r=i[n];if(null!=getConfigurableByType(r.type)){var a=newInstance(getConfigurableByType(r.type),r);this.stage.addChild(a),this.addToEntityMap(a)}}this.trigger=new egret.Shape,this.trigger.name="startTrigger",this.trigger.graphics.beginFill(65280,.2),this.trigger.graphics.drawRect(0,0,this.stage.stage.stageWidth,100),this.trigger.graphics.endFill(),this.trigger.x=0,this.trigger.y=this.bat.y,this.trigger.touchEnabled=!0,this.stage.addChild(this.trigger),this.deadZone=new egret.Shape,this.deadZone.name="deadZone",this.deadZone.graphics.beginFill(1644912,.2),this.deadZone.graphics.drawRect(0,0,this.stage.width,100),this.deadZone.graphics.endFill(),this.deadZone.x=0,this.deadZone.y=this.bat.y+(this.stage.height-this.bat.y)/2,this.stage.addChild(this.deadZone),this.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchTapInitBegin,this),this.stage.dispatchEvent(new GameProcessEvent("STAGE_START"))},e.prototype.onTouchTapInitBegin=function(e){egret.log("on onTouchTapInitBegin begin");for(var t=0,n=this.balls;t<n.length;t++){var i=n[t];i.speedY=-12,i.speedX=0}this.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchTapInitBegin,this),this.trigger.addEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchTapPlaying,this),this.trigger.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchTapPlaying,this)},e.prototype.update=function(e){for(var t=0,n=this.balls;t<n.length;t++){var i=n[t];i.update(e);var r=i.getTransformedBounds(this.stage),a=this.deadZone.getTransformedBounds(this.stage);if(a.intersects(r)){this.stage.removeChild(i);var s=this.balls.indexOf(i);this.balls.splice(s,1),this.isStageFail()&&this.stageFail()}var o=this.bat.getTransformedBounds(this.stage);if(o.intersects(r)&&this.bat.onHit(i),null!=this.entityMap[WALL])for(var h=0,c=this.entityMap[WALL];h<c.length;h++){var u=c[h],l=u.getTransformedBounds(this.stage);l.intersects(r)&&u.onHit(i)}if(null!=this.entityMap[BRICK])for(var g=0,p=this.entityMap[BRICK];g<p.length;g++){var d=p[g],f=d.getTransformedBounds(this.stage);f.intersects(r)&&(d.onHit(i),this.isStageSuccess()&&this.stageSuccess())}}return!1},e.prototype.onTouchTapPlaying=function(t){if(null!=this.bat){this.bat.x=t.stageX;var n=this.bat.getTransformedBounds(e.getInstance().stage),i=n.clone();i.inflate(this.balls[0].width/2,this.balls[0].height/2)}},e.gm=new e,e}();__reflect(GameManager.prototype,"GameManager");var ThemeAdapter=function(){function e(){}return e.prototype.getTheme=function(e,t,n,i){function r(e){t.call(i,e)}function a(t){t.resItem.url==e&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,a,null),n.call(i))}var s=this;if("undefined"!=typeof generateEUI)egret.callLater(function(){t.call(i,generateEUI)},this);else if("undefined"!=typeof generateEUI2)RES.getResByUrl("resource/gameEui.json",function(e,n){window.JSONParseClass.setData(e),egret.callLater(function(){t.call(i,generateEUI2)},s)},this,RES.ResourceItem.TYPE_JSON);else if("undefined"!=typeof generateJSON)if(e.indexOf(".exml")>-1){var o=e.split("/");o.pop();var h=o.join("/")+"_EUI.json";generateJSON.paths[e]?egret.callLater(function(){t.call(i,generateJSON.paths[e])},this):RES.getResByUrl(h,function(n){window.JSONParseClass.setData(n),egret.callLater(function(){t.call(i,generateJSON.paths[e])},s)},this,RES.ResourceItem.TYPE_JSON)}else egret.callLater(function(){t.call(i,generateJSON)},this);else RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,a,null),RES.getResByUrl(e,r,this,RES.ResourceItem.TYPE_TEXT)},e}();__reflect(ThemeAdapter.prototype,"ThemeAdapter",["eui.IThemeAdapter"]);var Ball=function(e){function t(t,n){var i=e.call(this)||this;return i.speedX=0,i.speedY=0,i.canMove=!0,i.name="ball",i.x=t,i.y=n,i.graphics.lineStyle(0,65280),i.graphics.beginFill(16711680,1),i.graphics.drawCircle(0,0,10),i.graphics.endFill(),i.backStage=GameManager.getInstance().stage,i}return __extends(t,e),t.prototype.update=function(e){this.x+=this.speedX,this.y+=this.speedY,(this.y<=0&&this.speedY<0||this.y>this.backStage.height&&this.speedY>0)&&(this.speedY=-this.speedY),this.x<=0&&this.speedX<0?this.speedX=-this.speedX:this.x>this.backStage.width&&this.speedX>0&&(this.speedX=-this.speedX)},t.prototype.revertXSpeed=function(){this.speedX=-this.speedX},t.prototype.revertYSpeed=function(){this.speedY=-this.speedY},t.prototype.getName=function(){return BALL},t}(egret.Sprite);__reflect(Ball.prototype,"Ball",["IMovable","IConfigurable"]);var Bat=function(e){function t(t){var n=e.call(this)||this,i=t.stage.stageWidth,r=t.stage.stageHeight;return n.name="bat",n.graphics.beginFill(121,1),n.graphics.drawRect(0,0,100,10),n.width=100,n.height=10,n.x=i/2-50,n.y=.8*r,n.graphics.endFill(),n}return __extends(t,e),t.prototype.getName=function(){return BAT},t.prototype.onHit=function(e){var t=this.getTransformedBounds(GameManager.getInstance().stage),n=t.clone();n.inflate(e.width/2,e.height/2);var i=this.calcPoints(n,e);if(console.log(i.length),i.length>0){var r=this.calcFirstIntersecPoint(i,e);if(console.log(r),null!=r){if(r.x==n.left||r.x==n.right)console.log("reverting x speed"),e.revertXSpeed();else if(r.y==n.top||r.y==n.bottom){var a=(n.left+n.right)/2;if(r.x!=a){var s=e.speedX/Math.abs(e.speedX);r.x<a&&e.speedX>=0?s=-1:r.x>a&&e.speedX<=0&&(s=1);var o=Math.pow(e.speedX,2)+Math.pow(e.speedY,2),h=Math.abs(a-r.x),c=1-h/n.width*2,u=4/9*Math.PI*c+(r.x>a?Math.PI/18:Math.PI/2);e.speedX=s*Math.abs(Math.sqrt(o/(1+Math.pow(Math.tan(u),2)))),e.speedY=-1*Math.abs(Math.tan(u)*e.speedX),e.speedY>0}else e.revertYSpeed()}if(this.deleteOnHit){var l=GameManager.getInstance().entityMap[this.getName()].indexOf(this);l>=0&&GameManager.getInstance().entityMap[this.getName()].splice(l,1),GameManager.getInstance().stage.removeChild(this)}}}},t}(RebounceObj);__reflect(Bat.prototype,"Bat");var AssetAdapter=function(){function e(){}return e.prototype.getAsset=function(e,t,n){function i(i){t.call(n,i,e)}if(RES.hasRes(e)){var r=RES.getRes(e);r?i(r):RES.getResAsync(e,i,this)}else RES.getResByUrl(e,i,this,RES.ResourceItem.TYPE_IMAGE)},e}();__reflect(AssetAdapter.prototype,"AssetAdapter",["eui.IAssetAdapter"]);var LoadingUI=function(e){function t(){var t=e.call(this)||this;return t.createView(),t}return __extends(t,e),t.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},t.prototype.onProgress=function(e,t){this.textField.text="Loading..."+e+"/"+t},t}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI",["RES.PromiseTaskReporter"]);var BRICK="brick",WALL="wall",BAT="bat",BALL="ball",type2nameMap={100:BRICK,200:WALL},configuableMap={BRICK:Brick,WALL:Wall},LoginUI=function(e){function t(){var t=e.call(this)||this;return t.addEventListener(egret.TouchEvent.TOUCH_END,t.onStart,t),t}return __extends(t,e),t.prototype.partAdded=function(t,n){e.prototype.partAdded.call(this,t,n)},t.prototype.childrenCreated=function(){e.prototype.childrenCreated.call(this)},t.prototype.onStart=function(e){(e.target.id="playBtn")&&(this.dispatchEvent(new GameProcessEvent("GAME_START")),GameManager.getInstance().initStage(StageMng.getInstance().getCurrentStage()))},t}(eui.Component);__reflect(LoginUI.prototype,"LoginUI",["eui.UIComponent","egret.DisplayObject"]);var Main=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.UIlayer=t,t}return __extends(t,e),t.prototype.createChildren=function(){e.prototype.createChildren.call(this),egret.lifecycle.addLifecycleListener(function(e){}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()};var t=new AssetAdapter;egret.registerImplementation("eui.IAssetAdapter",t),egret.registerImplementation("eui.IThemeAdapter",new ThemeAdapter);var n=this;this.runGame()["catch"](function(e){console.log(e)}).then(function(){return egret.startTick(n.update,n)})},t.prototype.runGame=function(){return __awaiter(this,void 0,void 0,function(){var e,t,n,i=this;return __generator(this,function(r){switch(r.label){case 0:return[4,this.loadResource()];case 1:return r.sent(),[4,this.createGameScene()];case 2:return r.sent(),[4,RES.getResAsync("description_json")];case 3:return e=r.sent(),[4,platform.login()];case 4:return r.sent(),[4,RES.getResAsync("myGame_json")];case 5:return t=r.sent(),PlayerMng.getInstance().chap<=0&&(PlayerMng.getInstance().chap=t.initChap,PlayerMng.getInstance().index=t.initIndex),[4,StageMng.getInstance().init()];case 6:return n=r.sent(),this.addEventListener(GameProcessEvent.GAME_END,function(){i.loginUI.visible=!0,i.gameGroup.mask=i.gameGroupMask},this),this.addEventListener(GameProcessEvent.STAGE_START,function(){i.loginUI.visible=!1,i.gameGroup.mask=null},this),this.addEventListener(GameProcessEvent.STAGE_PAUSED,function(){i.loginUI.visible=!0,i.gameGroup.mask=i.gameGroupMask},this),this.addEventListener(GameProcessEvent.STAGE_RETURN,function(){i.loginUI.visible=!1,i.gameGroup.mask=null},this),[2]}})})},t.prototype.loadResource=function(){return __awaiter(this,void 0,void 0,function(){var e,t;return __generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),e=new LoadingUI,this.stage.addChild(e),[4,RES.loadConfig("default.res.json","http://139.155.27.151:8080/res/resource/")["catch"](function(e){})];case 1:return n.sent(),[4,RES.loadGroup("preload",0,e)];case 2:return n.sent(),[4,this.loadTheme()];case 3:return n.sent(),this.stage.removeChild(e),[3,5];case 4:return t=n.sent(),console.error(t),[3,5];case 5:return[2]}})})},t.prototype.loadTheme=function(){var e=this;return new Promise(function(t,n){egret.ImageLoader.crossOrigin="anonymous";var i=new eui.Theme("resource/default.thm.json",e.stage);i.addEventListener(eui.UIEvent.COMPLETE,function(){t()},e)})},t.prototype.update=function(e){return GameManager.getInstance().update(e),!1},t.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return this.gameGroupMask=new eui.Group,this.gameGroupMask.width=this.width,this.gameGroupMask.height=this.height,this.gameGroupMask.touchThrough=!0,this.addChild(this.gameGroupMask),this.gameGroup=new eui.Group,this.gameGroup.width=this.width,this.gameGroup.height=this.height,this.addChild(this.gameGroup),this.loginUI=new LoginUI,this.addChild(this.loginUI),GameManager.getInstance().init(this.gameGroup),[2]})})},t.prototype.createBitmapByName=function(e){var t=new egret.Bitmap,n=RES.getRes(e);return t.texture=n,t},t.prototype.onButtonClick=function(e){var t=new eui.Panel;t.title="Title",t.horizontalCenter=0,t.verticalCenter=0,this.addChild(t)},t}(eui.UILayer);__reflect(Main.prototype,"Main");var DebugPlatform=function(){function e(){}return e.prototype.getUserInfo=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,{nickName:"username"}]})})},e.prototype.login=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})},e}();__reflect(DebugPlatform.prototype,"DebugPlatform",["Platform"]),window.platform||(window.platform=new DebugPlatform);var GameProcessEvent=function(e){function t(t,n){return void 0===n&&(n=!1),e.call(this,t,!0,n)||this}return __extends(t,e),t.GAME_START="GAME_START",t.STAGE_START="STAGE_START",t.STAGE_END="STAGE_END",t.GAME_END="GAME_END",t.STAGE_PAUSED="STAGE_PAUSED",t.STAGE_RETURN="STAGE_RETURN",t}(egret.Event);__reflect(GameProcessEvent.prototype,"GameProcessEvent");var PlayerMng=function(){function e(){this.chap=-1,this.index=-1,this.status=0}return e.getInstance=function(){return e.playerMng},e.playerMng=new e,e}();__reflect(PlayerMng.prototype,"PlayerMng");var StageMng=function(){function e(){this.stageMap={}}return e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(n){switch(n.label){case 0:return[4,RES.loadGroup("stage",8).then(function(){for(var n=RES.getGroupByName("stage"),i=0,r=n;i<r.length;i++){var a=r[i],s=RES.getRes(a.name),o=e.createKey(s.chap,s.index);t.stageMap[o]=s}})];case 1:return n.sent(),[2]}})})},e.getInstance=function(){return e.stageMng},e.createKey=function(e,t){return e+","+t},e.prototype.getByChapAndIndex=function(t,n){var i=e.createKey(t,n);return this.stageMap[i]},e.prototype.getCurrentStage=function(){var t=e.createKey(PlayerMng.getInstance().chap,PlayerMng.getInstance().index);return this.stageMap[t]},e.prototype.getNextStage=function(){return null},e.prototype.isLastStage=function(){return!1},e.stageMng=new e,e}();__reflect(StageMng.prototype,"StageMng");